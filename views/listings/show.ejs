<% layout("/layouts/boilerplate") %>
<script>
  const mapToken = "<%= process.env.MAP_TOKEN %>";
  window.listing = <%- JSON.stringify(listing) %>;
</script>

<!-- Listing Details Page -->
<div class="listing-details-container">
  
  <!-- Header Section -->
  <div class="listing-header">
    <div class="listing-header-content">
      <h1 class="listing-title"><%= listing.title %></h1>
      <div class="listing-subtitle">
        <div class="listing-rating">
          <i class="fa-solid fa-star"></i>
          <span class="rating-value">4.8</span>
          <span class="rating-count">(127 reviews)</span>
        </div>
        <span class="location-link">
          <i class="fa-solid fa-location-dot"></i>
          <%= listing.location %>, <%= listing.country %>
        </span>
      </div>
    </div>
    
    <!-- Action Buttons -->
    <div class="listing-actions">
      <button class="action-btn share-btn">
        <i class="fa-solid fa-share"></i>
        <span>Share</span>
      </button>
      <button class="action-btn save-btn" data-listing-id="<%= listing._id %>">
        <i class="fa-regular fa-heart"></i>
        <span>Save</span>
      </button>
      <% if(currentUser && listing.owner._id.equals(currentUser._id)) { %>
        <a href="/listings/<%= listing._id %>/edit" class="action-btn edit-btn">
          <i class="fa-solid fa-pen"></i>
          <span>Edit</span>
        </a>
      <% } %>
    </div>
  </div>

  <!-- Image Gallery -->
  <div class="listing-gallery">
    <div class="main-image">
      <img src="<%= listing.image.url %>" alt="<%= listing.title %>" class="gallery-image">
    </div>
  </div>

  <!-- Main Content -->
  <div class="listing-main-content">
    
    <!-- Left Column -->
    <div class="listing-info-section">
      
      <!-- Host Info -->
      <div class="host-info">
        <div class="host-details">
          <h2 class="host-title">Hosted by <%= listing.owner.username %></h2>
          <div class="host-stats">
            <span>4 guests</span> 路 <span>2 bedrooms</span> 路 <span>2 beds</span> 路 <span>1 bathroom</span>
          </div>
        </div>
        <div class="host-avatar">
          <i class="fa-solid fa-user"></i>
        </div>
      </div>

      <hr class="section-divider">

      <!-- Description -->
      <div class="listing-description">
        <p><%= listing.description %></p>
      </div>

      <hr class="section-divider">

      <!-- Amenities -->
      <div class="amenities-section">
        <h3 class="section-title">What this place offers</h3>
        <div class="amenities-grid">
          <div class="amenity-item">
            <i class="fa-solid fa-wifi"></i>
            <span>Wifi</span>
          </div>
          <div class="amenity-item">
            <i class="fa-solid fa-car"></i>
            <span>Free parking</span>
          </div>
          <div class="amenity-item">
            <i class="fa-solid fa-tv"></i>
            <span>TV</span>
          </div>
          <div class="amenity-item">
            <i class="fa-solid fa-snowflake"></i>
            <span>Air conditioning</span>
          </div>
        </div>
      </div>

    </div>

    <!-- Right Column - Booking Card -->
    <div class="booking-card-section">
      <div class="booking-card">
        <div class="booking-header">
          <div class="price-info">
            <span class="price">$<%= listing.price.toFixed(2) %></span>
            <span class="price-period">night</span>
          </div>
          <div class="booking-rating">
            <i class="fa-solid fa-star"></i>
            <span>4.8</span>
            <span class="review-count">(127 reviews)</span>
          </div>
        </div>

        <div class="booking-form">
          <% if(currentUser) { %>
            <form id="bookingForm">
              <div class="date-inputs">
                <div class="date-input">
                  <label>CHECK-IN</label>
                  <input type="date" id="checkInDate" name="checkInDate" required>
                </div>
                <div class="date-input">
                  <label>CHECKOUT</label>
                  <input type="date" id="checkOutDate" name="checkOutDate" required>
                </div>
              </div>
              <div class="guests-input">
                <label>GUESTS</label>
                <select id="numberOfGuests" name="numberOfGuests" required>
                  <option value="" disabled selected>Select guests</option>
                  <option value="1">1 guest</option>
                  <option value="2">2 guests</option>
                  <option value="3">3 guests</option>
                  <option value="4">4 guests</option>
                  <option value="5">5+ guests</option>
                </select>
              </div>
              <button type="button" class="reserve-btn" id="bookNowBtn" disabled>Reserve</button>
            </form>
            <p class="booking-note">You'll be redirected to PayPal for payment</p>
          <% } else { %>
            <p class="login-prompt">
              <a href="/login">Log in</a> to make a reservation
            </p>
          <% } %>
        </div>

        <div class="price-breakdown">
          <div class="price-row">
            <span id="priceDisplay">$0.00 x 0 nights</span>
            <span id="subtotal">$0.00</span>
          </div>
          <hr>
          <div class="price-row total">
            <span>Total (USD)</span>
            <span id="totalPrice">$0.00</span>
          </div>
        </div>

        <% if(currentUser && listing.owner._id.equals(currentUser._id)) { %>
          <div class="owner-actions">
            <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE" class="delete-form">
              <button type="submit" class="delete-btn">
                <i class="fa-solid fa-trash"></i>
                Delete Listing
              </button>
            </form>
          </div>
        <% } %>
      </div>
    </div>

  </div>

  <!-- Reviews Section -->
  <div class="reviews-section">
    <div class="reviews-header">
      <h2 class="section-title">
        <i class="fa-solid fa-star"></i>
        4.8 路 127 reviews
      </h2>
    </div>

    <div class="reviews-grid">
      <% if(listing.reviews.length > 0) { %>
        <% for (review of listing.reviews) { %>
          <div class="review-card">
            <div class="review-header">
              <div class="reviewer-avatar">
                <i class="fa-solid fa-user"></i>
              </div>
              <div class="reviewer-info">
                <h4 class="reviewer-name"><%= review.author.username %></h4>
                <div class="review-rating">
                  <div class="starability-result" data-rating="<%= review.rating %>"></div>
                </div>
              </div>
              <% if(currentUser && (review.author._id.equals(currentUser._id) || listing.owner._id.equals(currentUser._id))) { %>
                <form method="POST" action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE" class="delete-review-form">
                  <button type="submit" class="delete-review-btn">
                    <i class="fa-solid fa-trash"></i>
                  </button>
                </form>
              <% } %>
            </div>
            <p class="review-comment"><%= review.comment %></p>
          </div>
        <% } %>
      <% } else { %>
        <p class="no-reviews">No reviews yet. Be the first to review!</p>
      <% } %>
    </div>

    <!-- Review Form -->
    <% if(currentUser) { %>
      <div class="review-form-section">
        <h3 class="form-title">Leave a review</h3>
        <form action="/listings/<%= listing._id %>/reviews" method="POST" novalidate class="needs-validation review-form">
          <div class="rating-input">
            <label class="form-label">Rating</label>
            <fieldset class="starability-slot">
              <input type="radio" id="no-rate" class="input-no-rate" name="review[rating]" value="1" checked aria-label="No rating." />
              <input type="radio" id="first-rate1" name="review[rating]" value="1" />
              <label for="first-rate1" title="Terrible">1 star</label>
              <input type="radio" id="first-rate2" name="review[rating]" value="2" />
              <label for="first-rate2" title="Not good">2 stars</label>
              <input type="radio" id="first-rate3" name="review[rating]" value="3" />
              <label for="first-rate3" title="Average">3 stars</label>
              <input type="radio" id="first-rate4" name="review[rating]" value="4" />
              <label for="first-rate4" title="Very good">4 stars</label>
              <input type="radio" id="first-rate5" name="review[rating]" value="5" />
              <label for="first-rate5" title="Amazing">5 stars</label>
            </fieldset>
          </div>
          <div class="comment-input">
            <label for="comment" class="form-label">Comments</label>
            <textarea id="comment" name="review[comment]" rows="4" class="form-control" placeholder="Share your experience..." required></textarea>
            <div class="invalid-feedback">Please provide a valid comment.</div>
          </div>
          <button type="submit" class="submit-review-btn">Submit review</button>
        </form>
      </div>
    <% } %>
  </div>

  <!-- Map Section -->
  <div class="map-section">
    <h2 class="section-title">Where you'll be</h2>
    <div class="map-container">
      <div id="map"></div>
    </div>
    <p class="map-location">
      <i class="fa-solid fa-location-dot"></i>
      <%= listing.location %>, <%= listing.country %>
    </p>
  </div>

</div>
<script src="/js/map.js"></script>

